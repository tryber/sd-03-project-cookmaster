<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cookmaster - Home</title>
  </head>
  <header>Cookmaster
    <nav>
    </nav>
  </header>
  <body>
    <div>
      <h1>Editar Receita</h1>
      <div>
        <%const nome = recipe[3]%>
        <%const recipeIngredients = recipe[4]%>
        <%const instructions = recipe[5]%>
        <form method='post' action="/recipes/<%=id%>">
          <div>
            <label for="recipeNew">Nome da Receita</label><br />
            <input data-testid="nome-receita" type="text" name="recipeNew" id="recipeNew" />
          </div>
          <div>
            Ingredientes
          </div>
          <div id="ingredientsContainer">
          </div>
          <div>
            <input data-testid="secretList" type="hidden" name="secretList" id="secretList"></input>
            <input data-testid="pageId" type="hidden" name="pageId" id="pageId" value=<%=id%>></input>   
          </div>
          <div>
            <input data-testid="ingredientes" type="text" name="ingredients" id="insertIngredients"/>
            <button data-testid="adicionar-ingrediente" type="button" id="addIng">Adicionar Ingrediente</button>
          </div>
          <div>
            <label for="howToDo">Modo de preparo</label><br />
            <input data-testid="modo-de-preparo" type="textArea" name="howToDo" id="howToDo" />
          </div>
          <div>
            <button data-testid="voltar" type="button" onclick="window.location.href='/recipes/<%=id%>';">Voltar</button>
            <button data-testid="postar-receita" type="submit">Salvar Receita</button>  
          </div>
      </div>
      <div>
        <% if (message) {%>
          <div>
            <%message%>
          </div>
        <% } %>
      </div>
    </div>
  </body>
  <script>
    // Gerando a lista de ingredientes
    const recipeName = document.getElementById('recipeNew');
    const instructionsInput = document.getElementById('howToDo');
    const ingredientsContainer = document.getElementById('ingredientsContainer');
    const secretListInput = document.getElementById('secretList');
    const ingredientValue = document.getElementById('insertIngredients');
    const insertIngredientButton = document.getElementById('addIng');
    const ingredientUnnordenedList = document.createElement('ul');

    // variáveis ejs. Ref. https://stackoverflow.com/questions/28603658/can-a-js-script-get-a-variable-written-in-a-ejs-context-page-within-the-same-fil
    const nome = '<%=nome%>';
    const recipeIngredients = '<%=recipeIngredients%>'.split(',');
    const instructions = '<%=instructions%>';

    // Criando um id para a lista não ordenada
    ingredientUnnordenedList.setAttribute("id", "ingredientsList");
    const ingredients = [...recipeIngredients];

    const secretListFiller = () => {
      let filler;
      ingredients.map((e) => {
        if (filler) {
          filler = `${filler},${e}`;
        } else {
            filler = `${e}`;
        }
        secretListInput.value = filler;
      });
    };

    // Função com recorrencia, foi a primeira que fiz, ficou demais
    const deleteIngredientsList = (id) => {
      const ingredientsUnnordenedList = document.getElementById('ingredientsList');
      if (ingredientsUnnordenedList.childElementCount === 0) {
        ingredientsContainer.removeChild(ingredientsUnnordenedList);
      }
      if (!id) {
        return null;
      }
      if (ingredientsUnnordenedList) {
        const lineToBeDeleted = document.getElementById(`li-${id}`);
        ingredientsUnnordenedList.removeChild(lineToBeDeleted);
      }
      deleteIngredientsList(undefined);
      return null;
    };

    const createDeleteButton = (value) => {
      const deleteButton = document.createElement('button');
      deleteButton.innerText = 'Excluir Ingrediente';
      deleteButton.setAttribute("id", `${value}`);
      deleteButton.setAttribute("class", 'deleteBtn');
      deleteButton.setAttribute("type", 'button');
      deleteButton.addEventListener('click', () => {
        const indexToDelete = ingredients.indexOf(deleteButton.id);
        deleteIngredientsList(deleteButton.id);
        ingredients.splice(indexToDelete, 1);
        secretListFiller();
      });
      return deleteButton;
    };

    const selectDeleteButtons = () => {
      const deleteButtons = document.getElementsByClassName('deleteBtn');
      return deleteButtons;
    };

    const createIngredient = (value) => {
      let ingredientRow = document.createElement('li');
      let row = document.createElement('div');
      value.map((e) => {
        ingredientRow.setAttribute('id', `li-${e}`);
        let deleteBtn = createDeleteButton(e);
        row.innerText = e;
        row.appendChild(deleteBtn);
        ingredientRow.appendChild(row);
        ingredientUnnordenedList.appendChild(ingredientRow);
        const list = ingredientUnnordenedList;
        ingredientsContainer.appendChild(list);
      });
    }

    insertIngredientButton.addEventListener('click', () => {
      ingredients.push(ingredientValue.value);
      createIngredient(ingredients);
      ingredientValue.value='';
      secretListFiller();
    });

    window.onload = () => {
      // Execute as funções aqui
      // Setando as entradas
      recipeName.value = nome;
      instructionsInput.value = instructions;
      // Não sei porque só funcionou usando map
      // createIngredient(ingredients);
      ingredients.map((e) => createIngredient([e]));
      ingredientValue.value='';
      secretListFiller();
    }
  </script>
</html>
